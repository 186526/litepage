<!DOCTYPE html>

<html>
  <header>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css"
    />
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"
    />
    <meta name="renderer" content="webkit" />
    <meta name="force-rendering" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  </header>

  <body>
    <app></app>
  </body>

  <template>
    <div class="box">
      <div class="block">
        <h1 class="title is-4" on:click="alert"><%= count %> (Clickable)</h1>
        <buttons>
          <button class="button is-primary is-light" on:click="changeValue">
            +5
          </button>
          <button class="button is-primary is-light" on:click="changeValue">
            +1
          </button>
          <button class="button is-primary is-light" on:click="to0">
            Clear
          </button>
          <button class="button is-primary is-light" on:click="changeValue">
            -1
          </button>
          <button class="button is-primary is-light" on:click="changeValue">
            -5
          </button>
        </buttons>
      </div>
      <div class="block">
        <progress class="progress is-small" value="<%= progress %>" max="100">
          <%= progress %>%
        </progress>
        <input
          placeholder="Progress"
          value="20"
          class="input is-primary"
          on:change="changeProgress"
        />
      </div>
      <div class="content">
        <p>
          Powered by <a href="https://lab.186526.xyz/litepage/">LitePage</a>
        </p>
      </div>
    </div>
  </template>

  <script type="module">
    import LitePage from "./main.js";
    const sleep = (time) => new Promise((resolve) => setTimeout(resolve, time));
    function quad(timeFraction) {
      return Math.pow(timeFraction, 2);
    }
    function animate({ timing, draw, duration }) {
      let start = performance.now();

      requestAnimationFrame(function animate(time) {
        let timeFraction = (time - start) / duration;
        if (timeFraction > 1) timeFraction = 1;

        let progress = timing(timeFraction);

        draw(progress);
        if (timeFraction < 1) {
          requestAnimationFrame(animate);
        }
      });
    }
    const App = new LitePage({
      count: 0,
      progress: 20,
      changeValue: (element, props) => {
        props.count += new Number(element.innerText);
        console.log(props.count);
      },
      to0: (element, props) => {
        props.count = 0;
        console.log(props.count);
      },
      alert: (element, props) => {
        alert(props.count);
      },
      changeProgress: async (element, props) => {
        animate({
          duration: 2000,
          timing: quad,
          draw: (progress) => {
            if (element.value < props.progress) {
              progress -= 1;
              progress *= -1;
              if (progress * props.progress < props.progress) {
                props.progress = progress * props.progress;
              }
            } else {
              if (progress * element.value > props.progress) {
                props.progress = progress * element.value;
              }
            }
          },
        });
      },
    });
    App.on("setValue", ({ obj, prop, value }) => {
      if (prop === "count") {
        if (value >= 50) {
          value = 50;
          alert("Max 50!");
        } else if (value <= -50) {
          value = -50;
          alert("Min -50!");
        }
      }
      return { obj, prop, value };
    })
      .create(from("template"))
      .mount("app");
    globalThis.App = App;
  </script>
</html>
